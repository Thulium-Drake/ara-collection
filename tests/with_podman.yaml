---
# Copyright (c) 2020 The ARA Records Ansible authors
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: Deploy and test ARA API with podman
  hosts: ara-api-server
  gather_facts: yes
  vars:
    ara_api_install_method: podman
    ara_api_version: latest
    ara_api_root_dir: "{{ ansible_user_dir }}/.ara-tests"
    ara_api_secret_key: testing
    ara_api_debug: true
    ara_api_log_level: DEBUG
    # Configure cleanup crons to exercise the code path during tests
    ara_api_configure_cron: true
  tasks:
    - name: Install podman and crontab
      become: yes
      package:
        name:
          - cronie
          - podman
        state: present

    - name: Set up the API with the ara_api Ansible role
      include_role:
        name: ara_api
        public: yes

    - name: Install ara[client] via pip to allow for tests
      pip:
        name: ara[client]

    # Despite installing from packages, we need access to the source for
    # running tests
    - name: Prepare git repository for ara
      git:
        repo: "{{ ara_api_source }}"
        dest: "{{ ara_api_source_checkout }}"
        version: "{{ (ara_api_version == 'latest') | ternary('HEAD', ara_api_version) }}"

    # These are tasks rather than a standalone playbook to give us an easy
    # access to all the variables within the same play.
    - include_tasks: test_tasks.yaml
